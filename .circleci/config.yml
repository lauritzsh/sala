version: 2

jobs:
  build:
    docker:
      - image: bitwalker/alpine-elixir-phoenix:1.6.6
    steps:
      - add_ssh_keys
      - checkout
      - run: apk update
      - run: apk add --no-cache yarn rsync openssh
      # FIXME: It is not working with ~/.ssh/known_hosts
      - run: ssh-keyscan $HOST >> etc/ssh/ssh_known_hosts
      # - run:
      #     command: mix do deps.get, compile
      #     working_directory: api
      - run:
          command: yarn && yarn build
          working_directory: client
      - run: rsync -va --delete client/build/* $CI_USER@$HOST:$CLIENT_DIR
